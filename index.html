<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="description" content="Relájate en esta escapada única y tranquila. El hotel se encuentra a 15 minutos del Desierto de la Tatacoa.">
    <meta name="keywords" content="Desierto de la Tatacoa, Hoteles Villavieja">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Isla Hotel Campestre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("TU_USER_ID"); // Reemplaza con tu clave pública de EmailJS
        })();
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "hotel-campestre-la-isla",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log("✅ Firestore conectado correctamente");

        async function verificarDisponibilidad(tipo, entrada, salida) {
            const reservasRef = collection(db, "reservas");
            const q = query(reservasRef,
                where("tipo", "==", tipo),
                where("entrada", "<", salida),
                where("salida", ">", entrada)
            );
            const snapshot = await getDocs(q);
            return snapshot.empty;  
        }

        document.addEventListener("DOMContentLoaded", () => {
            const reservaForm = document.getElementById("reservaForm");
            const spinner = document.getElementById("spinner");
            const reservarBtn = reservaForm.querySelector("button");

            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('menu').classList.toggle('hidden');
            });

            document.querySelectorAll("#menu a").forEach(link => {
                link.addEventListener("click", () => {
                    document.getElementById("menu").classList.add("hidden");
                });
            });

            reservaForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const nombre = document.getElementById("nombre").value.trim();
                const email = document.getElementById("email").value.trim();
                const entrada = new Date(document.getElementById("entrada").value);
                const salida = new Date(document.getElementById("salida").value);
                const tipo = document.getElementById("tipo").value;
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);

                if (!nombre || !email || isNaN(entrada) || isNaN(salida)) {
                    alert("⚠️ Por favor, completa todos los campos.");
                    return;
                }
                if (entrada < hoy) {
                    alert("⚠️ La fecha de entrada no puede ser anterior a hoy.");
                    return;
                }
                if (entrada >= salida) {
                    alert("⚠️ La fecha de salida debe ser después de la fecha de entrada.");
                    return;
                }

                reservarBtn.disabled = true;
                reservarBtn.textContent = "Verificando...";
                spinner.classList.remove("hidden");

                const disponible = await verificarDisponibilidad(tipo, entrada.toISOString().split("T")[0], salida.toISOString().split("T")[0]);

                if (!disponible) {
                    alert("❌ Lo sentimos, esas fechas ya están reservadas. Por favor, elige otras.");
                    reservarBtn.disabled = false;
                    reservarBtn.textContent = "Reservar";
                    spinner.classList.add("hidden");
                    return;
                }

                try {
                    await addDoc(collection(db, "reservas"), { 
                        nombre, 
                        email, 
                        entrada: entrada.toISOString().split("T")[0], 
                        salida: salida.toISOString().split("T")[0], 
                        tipo 
                    });

                    emailjs.send("TU_SERVICE_ID", "TU_TEMPLATE_ID", {
                        nombre,
                        email,
                        tipo,
                        entrada: entrada.toISOString().split("T")[0],
                        salida: salida.toISOString().split("T")[0]
                    }).then(() => {
                        console.log("✉️ Correo de confirmación enviado");
                    }).catch((error) => {
                        console.error("❌ Error al enviar el correo:", error);
                    });

                    alert("✅ Reserva realizada con éxito");
                    reservaForm.reset();
                } catch (error) {
                    console.error("❌ Error al guardar la reserva:", error);
                    alert("❌ No se pudo completar la reserva. Inténtalo más tarde.");
                } finally {
                    reservarBtn.disabled = false;
                    reservarBtn.textContent = "Reservar";
                    spinner.classList.add("hidden");
                }
            });

            // Consulta de reservas por correo
            const consultaForm = document.getElementById("consultaForm");
            if (consultaForm) {
                consultaForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const email = document.getElementById("consultaEmail").value.trim();
                    const resultado = document.getElementById("resultadoReservas");
                    resultado.innerHTML = "";

                    if (!email) {
                        alert("⚠️ Por favor, ingresa un correo electrónico.");
                        return;
                    }

                    const reservasRef = collection(db, "reservas");
                    const q = query(reservasRef, where("email", "==", email));
                    const snapshot = await getDocs(q);

                    if (snapshot.empty) {
                        resultado.innerHTML = `<p class="text-red-500 text-center">❌ No se encontraron reservas para este correo.</p>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        resultado.innerHTML += `
                            <div class="border p-4 rounded bg-gray-50 shadow">
                                <p><strong>Nombre:</strong> ${data.nombre}</p>
                                <p><strong>Correo:</strong> ${data.email}</p>
                                <p><strong>Tipo:</strong> ${data.tipo}</p>
                                <p><strong>Entrada:</strong> ${data.entrada}</p>
                                <p><strong>Salida:</strong> ${data.salida}</p>
                            </div>
                        `;
                    });
                });
            }
        });
    </script>
</head>
<body class="bg-gray-100 text-gray-900">
    <!-- (Tu cuerpo HTML permanece igual hasta el final del formulario de reservas) -->

    <!-- Nueva sección: Consulta de reservas -->
    <section class="max-w-4xl mx-auto p-6 bg-white shadow-lg rounded-lg mt-10">
        <h2 class="text-2xl font-bold mb-4 text-center">Consultar Mis Reservas</h2>
        <form id="consultaForm" class="space-y-4">
            <div>
                <label for="consultaEmail" class="block mb-1 font-semibold">Correo Electrónico</label>
                <input type="email" id="consultaEmail" class="w-full p-2 border rounded transition duration-300 hover:border-yellow-500 focus:outline-none focus:ring focus:ring-yellow-300" required>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold w-full transition-transform hover:scale-105 hover:bg-blue-400">Ver mis reservas</button>
        </form>
        <div id="resultadoReservas" class="mt-6 space-y-4"></div>
    </section>

    <footer class="bg-black text-white py-8 mt-16 text-center">
        <p>&copy; 2025 La Isla Hotel Campestre - Todos los derechos reservados</p>
    </footer>
</body>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const entradaInput = document.getElementById("entrada");
        const salidaInput = document.getElementById("salida");

        function actualizarFechasMin() {
            const hoy = new Date().toISOString().split("T")[0];
            entradaInput.min = hoy;
            salidaInput.min = hoy;
        }

        entradaInput.addEventListener("change", () => {
            salidaInput.min = entradaInput.value;
            salidaInput.value = "";
        });

        actualizarFechasMin();
    });
</script>
</html>

